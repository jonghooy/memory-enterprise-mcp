# Memory Enterprise KMS (Knowledge Management System) Configuration
# Add this to the main HTTPS server block in /etc/nginx/sites-available/llmdash

# Define upstream for KMS frontend
upstream kms_frontend {
    server localhost:3000;
}

# KMS Frontend - Memory Enterprise Knowledge Management System
location /kms/ {
    proxy_pass http://kms_frontend/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;

    # For Next.js WebSocket support (HMR in dev)
    proxy_read_timeout 86400;
}

# Redirect /kms to /kms/
location = /kms {
    return 301 /kms/;
}

# Next.js static files
location /kms/_next/ {
    proxy_pass http://kms_frontend/_next/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Cache static assets
    proxy_cache_valid 200 30d;
    add_header Cache-Control "public, max-age=31536000, immutable";
}

# KMS API endpoints (for future backend integration)
location /kms/api/ {
    # When backend is ready, point to FastAPI server at port 8000
    # For now, proxy to Next.js API routes
    proxy_pass http://kms_frontend/api/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # SSE support for streaming
    proxy_buffering off;
    proxy_cache off;
    proxy_set_header Connection '';
    chunked_transfer_encoding off;
}